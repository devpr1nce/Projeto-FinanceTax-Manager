from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///finance.db"
db = SQLAlchemy(app)

class Client(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    cnpj = db.Column(db.String(20))

class Transaction(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    client_id = db.Column(db.Integer, db.ForeignKey("client.id"))
    type = db.Column(db.String(10))  # receita ou despesa
    value = db.Column(db.Float)
    tax = db.Column(db.Float)

@app.route("/clients", methods=["POST"])
def add_client():
    data = request.json
    client = Client(name=data["name"], cnpj=data["cnpj"])
    db.session.add(client)
    db.session.commit()
    return jsonify({"message": "Cliente cadastrado!"})

@app.route("/transactions", methods=["POST"])
def add_transaction():
    data = request.json
    transaction = Transaction(
        client_id=data["client_id"],
        type=data["type"],
        value=data["value"],
        tax=calculate_tax(data["type"], data["value"])
    )
    db.session.add(transaction)
    db.session.commit()
    return jsonify({"message": "Transação registrada!"})

def calculate_tax(t_type, value):
    if t_type == "servico":
        return value * 0.05  # ISS
    elif t_type == "produto":
        return value * 0.18  # ICMS
    return 0

if __name__ == "__main__":
    db.create_all()
    app.run(debug=True)
